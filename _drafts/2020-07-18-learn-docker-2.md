---
title:  "도커 학습기 #2"
excerpt: "패캠 도커 강의 노트 2 : 도커로 프로젝트 환경 구축하기"


categories:
-   Docker
tags:
-   Docker
last_modified_at: 2020-07-18TO22:30:00+09:00
---

## 오늘 수업 커리큘럼

- Docker Compose
- 개발 환경 구성
- Docker Hub와 Registry
- 도커 CI 환경구성
- nGrinder 테스트 팜 구축
- 어플리케이션 빌드

+지난 수업에서 못한 내용부터 시작함

## 들어가며

지난 주 수업의 목표는 **로컬 프로젝트 환경 구성**이었다.

### 지난 주 숙제 dockersay 수정하기

지난 주에 만든 이미지는 우리 파일을 넣은 적이 없다.
fortune이라는 unix utility를 설치하고 실행한 것이다.

하지만 우리 파일도 넣는 작업이 필요하다.
이 실습의 목적은 **내가 만들 도커 이미지에 서비스 파일을 집어넣을 수 있다.**

### 결국은 VM을 잘 쓸줄 알아야함

컨테이너를 배우는 과목이지만, VM도 잘 쓸줄 알아야한다.
우리는 리눅스가 아니라 윈도우 또는 맥을 사용하기 때문에.

- Docker Machine
  - 이것도 VM이다.

도커 머신은, 가상서버에 도커엔진을 설치할 수 있게 도와주는 도구이다.
컨테이너가 아니라, 하이퍼바이저 기반이다.
이 가상서버에 도커 엔진을 설치한다. 이 가상서버가 도커 호스트 서버가 된다.

일일히 가상서버 만들고 ssh 들어가서 엔진 설치하고 인증서 설치하고 ...
이런 작업은 번거롭고 귀찮다.
이런 귀찮은 일을 한번에 해결해주는 도구가 도커 머신이다.

가상 서버를 도커 호스트로 구축하는 걸 도와주는 도구이다.

얘를 이용하면 다양한 가상서버를 쉽게 만들 수 있다. AWS 같은.

### Docker machine 유스케이스

두 가지 유스케이스가 있다.

- 로컬에 도커엔진 설치
- 리모트 서버에 도커엔진 설치

boot2docker
도커 컨테이너를 실행하기 위한 가벼운 리눅스 배포판이다.
Docker Machine의 기본 설정이다.
얘는 개발용이고, 운영용으로 쓰는게 아니다.

운영 서버를 준비할 때는 회사에서 기본으로 가져가는 풀옵션 서버 사용한다.

### Docker-machine 주요 명령어

도커 머신 실습하는데 나는 일단 안깔려있음
왜 데스크탑 깔면 있다고하는데 나는 업냐아~

도커 머신 사용하려면 기본적인 하이퍼바이저가 깔려있어야한다.

여러 개의 호스트 서버를 만드는데 도움을 준다.

### Vagrant : Docker-machine 보다 많이 쓰는 도구

도커 머신을 설명한 이유는, 간단하기 때문이다.
개발용으로 쓰기 위해서는 도커머신도 좋다
> 수시로 만들었다가 지울 수 있다

하지만 Default 배포판이 Tiny Unix이다. 물론 다른 걸로 명시해서 쓸 수 있다.
그래도 귀찮잖아.

Vagrant는 역할만 보면 똑같다.
하지만 훨씬 더 다양한 리눅스 배포판을 지원한다.
다양한 가상머신을 동일한 방식으로 만들고 관리할 수 있게 해주는 도구이다.

Vagrant Box는 Vagrant로 만들 수 있는 가상서버 유형이다.
왠만한거 다 있다.

### 추천하는 Vagrant 샘플 파일

Coreos이다.
성능도 좋구 추천하셨다

### 이거 두개는 두개다 컨테이너 기술은 아니고 하이퍼바이저 기술이다

다음주 멀티호스트 구축할 때 쓸 것이다.

## 도커 호스트 구성 유스케이스

### 1) 독립된 로컬 개발환경

Vagrant나 Docker Machine을 이용해서 가상 호스트 서버를 만들고,
거기에 도커로 개발환경을 다 구축해서 써라.

이렇게 쓰다보면 편하긴 한데 제약이 따를 수 밖에 없다.

### 2) VM 기반의 도커 Host

로컬 상에서 구축하지말고, 외부에 있는 클라우드나 인하우스의 서버로 써라.
외부에 있는 VM 기반의 도커 Host를 만들어 놓고,
그 도커 Host에 접속해서 쓰는 상태로 발전하라.
그래야 제대로된 도커 운영 환경 경험해볼 수 있다.

### 3) 싱글 물리서버 도커 Host

물리서버 1대로 도커 Host를 구성한다.
가상서버에 비해서 여러가지 많이 해볼 수 있다.
> 얼마 만큼 컨테이너를 띄울 수 있는지와 같은 일들.

### 3+) 싱글서버 도커 Host+VM

### 4) 도커 Host 클러스터

이게 swarm, kubernetes 이런거 사용하는 것이다.
여러 도커 호스트 서버를 하나의 호스트 처럼 관리하기 위해 클러스터를 구성한다.
컨테이너 스케쥴링, Host 모니터링 등이 필요하다.

## 도커 이미지 백업

`docker save busybox > busybox.tar`
busybox 이미지를 압축파일로 복사한다.
`docker load < busybox.tar`
busybox.jar 파일을 이미지로 가져온다.

## 컨테이너 데이터 백업

더이상 서버는 **Pet이 아니라 Cattle이다.**

Cattle은 언제든 대체가 된다. Pet은 다른 똑같은 Pet을 사온다고해서 대체가 되지 않는다.
이게 가능하려면 무상태여야한다.
**컨테이너를 무상태로 접근해야한다.**

이제는 컨테이너가 이상하면 들어가서 고치지 않는다.
**바로 지우고 다시 띄운다. 그래서 내부에 데이터가 있으면 안된다.**
그래서 컨테이너를 백업하는게 중요하다.

### 데이터 볼륨

우리가 쓰려고하는 mysql 도커파일 들어가보면, 정의되어 있어야한다!!!
`/var/lib/mysql`
이 위치는 mysql 도커파일에 **정해져있다.**
내가 이 위치의 데이터를 백업해야한다!

**기본적으로 도커파일이 없는 이미지를 쓰지 마라. 권장하지 않음.**

`~~~ --name mydb -d -v /mysqldata:/var/lib/mysql mysql:5.6`
**이거는 도커 엔진상의 볼륨에 들어가는 것이다!**

최초로 바인딩할때 디렉토리에 아무것도 없으면, 디렉토리 만들어서 넣어준다.
있으면 있던게 지워지지 않고 오버라이드해서 쓴다.

## 내 나름의 짚고 넘어가기

일단 로컬 환경에 도커 엔진으로 로컬 개발환경 구성하는 법을 배웠는데,
아예 내 컴퓨터 로컬이 아니라, 가상 서버를 띄워서 쓰고 싶은거야.
이때 쓰는게 하이퍼바이저 기술인거잖아
그 도구가 Virtualbox 같은건데, 이걸 편하게 만들 수 있게하는게
Docker-machine이나 vagrant이다.

### DB 설정

`docker run -e`
`MYSQL_ROOT_PASSWORD = 'Passw0rd' --name mydb`
`-d -v /mysqldata:/var/lib/mysql`
`-v /home/docker/my.cnf:/etc/mysql/conf.d/my.cnf`
`mysql:5.6`
이대로 그냥 써도 된다!
마이에스큐엘 개발 환경으로

### 데이터 컨테이너

다른 컨테이너에게 볼륨을 공유하기 위해 만드는 컨테이너이다.
애플리케이션을 실행하지 않는다.

/data/app1 디렉토리를 공유하는 데이터 컨테이너를 만든다.
`docker run --name mydata -v /data/app1 busybox true`

mydata 컨테이너를 참조하는 컨테이너를 만든다.
`docker run -it --volumes-from mydata ubuntu:14.04`
-it옵션: 인터렉티브 모드
exit으로 나오면 된다.

### 인터렉티브 모드

리눅스를 잘 모른다. 여러가지 배포판 써보고 싶다.
그러면 도커로 컨테이너 만들어서 인터렉티브로 들어가서 써보고 나오면 된다.

## 본 2강 수업

오늘 할 내용 : 도커를 여러명이 함께 쓰는 내용이다.

여러개 컨테이너를 동시에 실행하고 싶다면 > Docker compose

### Docker compose

여러개 컨테이너 구성된 어플리케이션을 만들고 관리할 수 있게 해주는 도구이다.
명령어 기반의 인터페이스이다. docker-compose.yml에 작성한다.

굉장한 단점이 있다! **싱글 호스트에서만 사용 가능하다.**
그래도 가장 많이 사용하기 때문에 꼭 알고 있어야 한다.
도커 명령어보다 더 많이 사용한다.

도커 머신은 클라이언트에서만 설치해서 쓰면 된다.
하지만 컴포즈는 서버에서도 사용할줄 알아야한다.
그럴때 curl을 사용해서 다운로드 해야한다.

### yml

**xml과 json의 중간적인 형태이다!**
xml은 너무 구조적이고, json은 너무 축약한 형태이다.

yml은 들여쓰기가 곧 계층구조를 나타낸다. 그래서 들여쓰기 없애면 오류남.

### Docker-compose.yml 문법 설명

- image
  - 빌드할 이미지를 저장한다
- build
  - 빌드에 적용할 옵션을 설정한다
- links
  - 다른 서비스에 컨테이너를 연결한다
- external-links
  - 현재 yml 외부에서 시작된 컨테이너를 연결한다
- ports
  - 포트를 드러낸다
- expose
  - 호스트 바인딩 없이 포트를 드러낸다
- volumes
  - 호스트와 컨테이너 특정 패스를 마운트한다
- volumes_from
  - 다른 서비스나 컨테이너로부터 볼륨을 마운트한다
- environment
  - 환경변수를 정의한다
- env_file
  - 환경변수를 정의하는 파일을 지정한다
- extends
  - 다른 서비스 설정을 상속바든다
- net
  - 네트워크 모드
- dns
  - 사설 dns 서버를 지정한다
- dns_search
  - 사설 dns 서버를 도메인으로 지정한다

### Docker-compose 주요 명령어

- docker-compose up
- docker-compose up -d
- docker-compose up -d no-create
- docker-compose ps
- docker-compose down
- docker-compose rm

### link의 원리

link를 걸면 도커 엔진이 컨테이너 hosts 파일에 필요한 정보를 주입시킨다.

호스트 파일을 핸들링하는 경우가 나오면? 나는 못한다. 도커가 해줘야한다.

### Docker-compose 실습하기

멘토님은 명령어를 쳤을때, 명령어가 모호하지 않은 것을 좋아하신대!
**Docker-compose.yml 그대로 쓰지 않고 -f 옵션으로 명시해준다.**

### links 옵션

컨테이너는 독립적이기 때문에 서로의 존재를 모른다.

## 도커로 개발 환경 구성하기

실습 자료하고 순서가 좀 다를 것이다.
CI를 뒤로 뺐다.

개발을 할때 쓰는 다양한 서비스들이 있다.
그걸 도커를 이용해서 구축해보자.

[https://github.com/marcelbirkner/docker-ci-tool-stack](https://github.com/marcelbirkner/docker-ci-tool-stack)
예시 repo

이 정도 툴 스택만 가지고 있으면, 프로젝트 하나에 필요한 개발 환경을 다 구성할 수 있다.

### 먼저 실습 환경을 만든다

서비스가 엄청 많이 올라가기 때문에 수업시간에는 못한다. 다운로드할게 많다.
일단 말로 설명하심.

모든 구성을 준비해서, 하나의 프로젝트를 만든다.
그래서 깃에 올려놓으면, 어떤 팀이 이 개발환경을 쓰겠다.
그냥 바로 쓸 수 있다.
이거에 대한 best practice 가 되는 repo 이다

### Gitlab

예전에는 Jenkins륾 많이 썼었는데, 제대로 할거면 차라리 git-lab을 추천한다.

## Docker hub와 Registry

### docker hub와 github의 차이점

깃허브에는 소스파일 여러개 넣는데, 도커헙은 다르다.
하나의 도커 이미지가 하나의 레파지토리가 되는 것이다.

### Registry

레지스트리란, 도커 이미지를 저장하고 공유할 수 있는 서버이다.
오픈소스이고 Apache 라이센스이다.
v1와 v2가 호환되지 않는다.

- 클라우드 : DockerHub
- 인트라넷 : DTR

`docker run -d -p 5000:5000 --name myregistry registry:2`
이렇게 해서 registry 컨테이너 실행한다.

`docker tag <docker-image-id> localhost:5000/docker-whale:latest`
이렇게 해서 이미지에 Private Repo 태그하기

`docker push localhost:5000/docker-whale:latest`
이미지를 푸시한다.

이렇게해서 로컬에 private repo로 사용할 수 있다.
그럼 이미지 데이터를 어디에 저장할 것인가?
`docker run -d -p 5000:5000 -v $(pwd)/registry-data:/var/lib/registry --name myregistry registry:2`
이 또한 데이터를 빼둬야 나중에 registry 컨테이너 죽었다 살아나도 그대로 쓸 수 있다.

꿀팁

- 운영하는데 고생하지말고 돈내고 쓴다
- 크고 좋은 서버로 레지스트리 돌린다

## CI 환경 구축

### 일반적인 CI 환경

### 일반 CI 환경

어플리케이션을 만들기 위한 형상
+도커 이미지를 만들기 위한 형상

데브옵스에서 Deployment pipeline

### Docker in Docker

도커 컨테이너가 원래는 도커 명령어를 실행할 수 없다.
특별한 경우에, 도커 컨테이너 내에서 도커 명령어를 실행한다.
이것이 **DND**라고 한다.

### DND 실습

우리가 하려면 젠킨스 컨테이너가 도커 명령어를 사용할 수 있어야한다!
그래서 젠킨스는 DND 컨테이너여야 한다.

### jenkins blueocean

이걸 이용하면 나중에 돌아가서 CI 환경으로 써도 된다.
(업데이트랑 무관한 것인가봄)

### Jenkins 를 쓰는 이유

플러그인이 많아서 갖다 쓰기 좋다.
