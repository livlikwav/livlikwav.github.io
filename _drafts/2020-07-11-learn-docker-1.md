---
title:  "도커 학습기 #1"
excerpt: "Docker 기반의 DevOps 인프라 구축 WORKSHOP 1강 수업 정리"


categories:
-   공부
tags:
-   Docker
last_modified_at: 2020-07-09TO22:30:00+09:00
---
- [너무 핫한 도커, 쿠버네티스](#너무-핫한-도커-쿠버네티스)
- [도커 시작하기](#도커-시작하기)
- [Docker getting-started](#docker-getting-started)
- [같이 공부한 용어들](#같이-공부한-용어들)
  - [SQLite 란](#sqlite-란)

# 200711 1일차 도커

Created: Jul 11, 2020 2:06 PM
Reviewed: No

# 강의 개요

11회차 > 1년에 3번씩 한다

강의 60프로, 실습 40프로

도커를 가장많이 써보는게 좋다.

대상: 도커초보자, 데브옵스 초보자

### 강사님 소개

삼성SDS 10년, NHN 3년, Sk planet 3.5년

현재 에스프레소북 창업

### **처음 배우는 Docker**

**– 도커를 사용할 수 있는 환경을 로컬에 구성할 수 있다.– 도커 이미지와 컨테이너를 이해하고 나에게 맞게 커스텀해본다.Docker 이해 및 환경 구성– Docker 히스토리– 리눅스 컨테이너 기술의 이해– Docker 툴박스를 이용한 Docker 로컬 환경 구성Docker 이미지– Docker 이미지 이해– Docker 이미지 사용– 나만의 도커 이미지 만들기Docker 컨테이너– Docker 컨테이너 이해– Docker 컨테이너 만들기– 컨테이너 연결하기**

### **Docker로 로컬 개발환경 구축하기**

**– 다양한 형태의 컨테이너를 만들수 있다.– 도커 머신으로 로컬에 개발환경을 꾸밀수 있다.VM 활용– Docker Machine, Vagrant 이해– 로컬에서 VM 환경 구성하기컨테이너 활용– Dockerfile 의 이해– 컨테이너 환경설정– 데이터 볼륨 컨테이너– 컨테이너 데이터 백업회차 과정 정리**

# 공지

매차수 앞에서 하드카피(인쇄한) 강의자료 가지고 가세요

# 강의 메모

Epic

도커가 무엇인지 설명할 수 있다

현재 진행하는 프로젝트에서 활용할 수 있다

도커 기반 DevOps 시스템 구축에 대한 감이 잡힌다

도커 전문가가 되기 위해서 무엇을 공부해야할지 알겠다

## 강의 구성

1일차 혼자쓰는거

2일차 함께쓰는거 - Docker compose

3일차 멀티호스트 구성

4일차 기술적으로 어려운 내용보다는 개념적으로 좀더 어려운 내용

오케스트레이션 도구인

Docker swarm, kubernetes 쿠버네티스는 구글에서 만든거

도커에 대한 지식과 경험

데브옵스에 대한 지식과 경험

## 수강생 소개

다들 회사원들이시다 ㅎㅎ..

### 도커는 무엇인가

리눅스 컨테이너 기술을 이용해 어플리케이션 패키징, 배포를 지원하는 경량의 가상화 플랫폼

엔진은 Go 언어로 개발

- 리눅스 컨테이너 기술
- 패키징
- 배포
- 경량
- 가상화

도커는 패키징과 배포 도구다

이제는 거의 stable 하다

엔터프라이즈

모니터링, 안정성~ 이런걸 내가 해야하는 불편함만 극복하면 커뮤니티 에디션으로 다 가능하다

go의 가장 성공한 사례가 도커임

깊게 쓰려면 go를 보게 되긴 합니다

### 왜 도커를 써야하나 : Matrix from Hell

박스로 감싼다.

도커라는 상자를 이용해서 우리 어플리케이션을 넣기만 하면 됨

Dockerizing

하이퍼바이저 기반 가상화 서비스 VMWare같은거

최소 10기가

### Immutable Infrastructure

이미지 기반의 어플리케이션 배포 파라다임

많은 서버를 동적으로 관리하는 클라우드 환경에서 효과적이고 유연한 배포 방식

- 마치 CD를 굽듯이 하는 거임
- 도커가 이걸 가능하게 해주는 기술이다

지금은 이미 업계 표준이됨

금방 나온기술이 아니다

한 10년에 걸쳐서 쓰여지고 쓰여지고 하다가 나온게 도커이다

구글같은 회사는 내부적으로 2004년부터 쓰고 있었다

리눅스 컨테이너 기술은

리눅스 컨테이너는 소개된지 10년이 지난 기술이다.

설정이 복잡하고 사용하기 어려워 널리 사용되지 못했다.

하지만 도커는 사용하기 쉽다

만만한 기술은 아니다. 배워야할 것과 알아야할 것이 많다.

도커를 쓰고 엄청 쉬워진거얌

future of linux containers

# 2교시

도커 CE 도 충분히 다 쓸수있다.

그냥 안정화와 관련된 기능을 내가 다 해야하는것 뿐이다

도커 클라이언트

CLI 한번 익숙해지고 나면 이게 훨씬 편하다.

그리고 운영환경에서도 CLI로 배우는게 훨씬 좋다

도커 데스크탑을 다운로드하는순간

아주 작은 가상서버를 만들어서 띄워놓은거

명령어를 치면 

맥에 깔려있는 조그만 가상머신에서 실행되는거

- 그게 xhyve/bhybe를 기반으로 하는 HyperKit을 임베디드 하이퍼바이저로 사용

각 클라이언트별로 가상화 기술에 대해 세팅이 잘되어있느냐에 따라서 다르다

맥은 좀 잘되고 윈도우는 케바케

윈도우는 도커를 사용하기에 좋은 환경은 아닌데, 많이 좋아졌음

리눅스가 최고의 환경임. 네이티브니까.

Kitemetic 

써보면 좋긴함. 클라이언트에서 재미삼아서 써볼만 하다

근데 프로덕션에서 쓰려면 이런걸로는 쓰지 못한다.

## Docker Engine

리눅스 서버에 도커 데몬 다운받음 (이 리눅스를 도커 호스트 오에스라고 부른다)

깔고나면 REST API가 드러나게 되고

도커 클라이언트가 이 인터페이스를 통해서 도커 엔진을 계속 호출함

도커 클라이언트는 사실상 하는게 없다.

도커 엔진과 도커 오케스트레이션 도구와 통합되어 있다.

Swarm, Kubernetes

Native level에서 다 통합이 되어있음.

### Native Level 에서 돌린다

가상머신위에서 도커 컨테이너가 ㄱ뜨는게 아니라

윈도우 서버위에서 바로 뜬다

윈도우는 NTFS, 리눅스 EST? 

윈도우가 너무 도커를 좋아해. 그래서 에뮬레이션하는 레벨을 하나 더 만들었음

## Docker Machine

이것도 다른 툴이다.

하이퍼바이저 기반의 가상 서버를 쉽게 만들어주는 도구

프로비저닝 클라이언트

한땀한땀 할수도 있는데, 그런걸 귀찮게 하지않고 한방에 해주는 거임.

## Docker Hub

도커가 성장하게 된 가장 큰 요인중에 하나라고 생각하신대.

왠만한 오픈소스는 다 들어있음.

그냥 이미지를 pulling해와서 쓰는 경우가 훨씬 많다.

## Docker Trusted Registry

도커 이미지 저장소를 구축할 수 있다

설치형, 인증 지원

Registry무료, DTR유료

### DTR은 필수야

호스트나 컨테이너가 많아지면 필수라서.

## DUCP

Docker Universal Control Plan

도커 클러스터 관리도구

설치형(유료)

대시보드 어플리케이션임> 사람이 관리하기 힘드니까

- 이건 비추라고 하심 ㅋㅋ

## Docker Conference

도커전문가가 되기 위해서 무엇을 공부해야하는지

도커 컨퍼런스의 과거 영상들이 다 무료로 공개되어 있다.

최신 도커 흐름을 파악할 수 있는 기회이다.

 

도커를 쓰면 어느 클라우드에 다 가지고 갈 수 있다

Choice : 클라우드, OS에 종속되지 않는다.

도커가 시리즈 A, B, C, D, E ... 투자 다 받음

시리즈 단계 올라갈때마다 10배

## 윈도우에 윈도우 컨테이너 띄우는게 네이티브라는거

리눅스 컨테이너 띄우려면 여전히 가상화 머신 사용해야함.

## 라즈베리파이에 도커를 올린다

EngineX

Uni-kernel로 만들면 5메가 이하로 해서 올릴 수 있음

도커가 IoT 기반의 OS로 성장하고 있다

서비스를 클라우드에 배포하는데 도커를 안쓰는 것은 바보같은 짓이다.

Vendor의 Lock-in을 피할 수 잇다

### Toolbox와 Desktop 차이

Toolbox는 작은 가상머신이 아니라 오라클 버츄얼박스가 깔리고

Default라고 하는 가상머신이 깔려있다

# 3교시

공유폴더설정 잘 사용하기

- 내가 배운 bind mount 내용인가봐

### 도커 아키텍쳐

Hypervisor

하이퍼바이저

- 호스트 컴퓨터에서 다수의 운영체제를 동시에 실행하기 위한 논리적 플랫폼

가상화 기술의 거의 표준

하나의 베어메탈 머신에서

물리서버 하나를 여러대의 가상 서버로 쓰는것이 일반적이다.

하나의 호스트 컴퓨터에 다수의 운영체제가 논리적으로 실행이 가능하게 한다.

### 하이퍼바이저

크게 나누면 Type1, Type2로 나뉜다.

Type1 기술은 호스트 OS가 아예 없다.

- 맥에서 패러렐즈 쓰는거 Hypervisor의 Type2 를 쓰는 것이다.
- Type1이 사실 훨씬 효율적이긴 하다

### 컨테이너와 하이퍼바이저

VM이 주택이면, Container는 아파트

- 큰 차이는 하이퍼바이저에는 Guest OS가 있다.

OS가 있긴있는건데 호스트 오에스를 빌려 쓰는 것이다.

초반에 뚜드려맞은 이유가 이것때문에 위험하다고 판단됬음.

게스트 오에스에 비해서 격리수준이 떨어지기때문에 덜 안전한거 같다라는 우려

### 리눅스 컨테이너 LXC, Linux Container

도커와 의존성이 있는 기술이 아니다.

LXC 기술을 구현해놓은 구현체는 따로 있다. Libvirt

도커에 대한 기반기술부터 계속 말함

### Union Filesystem

도커에 다양한 파일시스템으로 만들어진 이미지가 되게 많아

근데 이걸 도커 하나로 사용할 수 있는게

Union Filesystem 때문에 쓸 수 있는거

host: ubuntu, container:CentOS

하지만 서로 마운트해서 쓰는거 가능하다

### 권한 수준

root user 와 동일한 수준의 권한 필요

docker daemon 실행하기 위해서는 root 사용자 필요

TCP 포트가 아닌 Unix 소켓과 데몬이 바인딩 하기 때문

사용자 그룹 docker, 사용자 docker

- 특정 TCP 포트로 바인딩하면 REST API를 밖으로 해서 쓸 수 있다 근데 이거 문제가 크다

이게 왜 중요한가

- 이 사용자가 달라지면?
- 도커 허브에 있는 수많은 이미지를 갖다 쓸때, 수많은 난관에 부딪힘.

가능하면 디폴트를 맞춰라 : 여러모로 편하다

아니면 권한수준을 맞춰라

권한수준이 다르면 바인딩에서 에러가 난다

## 도커 이미지

서비스를 배포할때 배포하는 단위가 이미지이다.

서비스를 배포하는 최소 단위가 도커 이미지다.

- 한 가지 유형의 이미지는 한가지 유형의 컨테이너를 만들 수 있다.
- 붕어빵 틀

도커이미지는 층층히 쌓여있다.

베이스 이미지는 보통 리눅스의 운영체제. Debian, CentOS

게스트 OS 대신 베이스 이미지가 있다고 생각해도 상관없다.

시스템, 서비스, 라이브러리 들이 층층히 올라가는 것이다.

**도커 이미지는 여러층을 가진 파일시스템이다. 레이어파일시스템**

### boots

도커 엔진이사용하는 파일시스템

우리가 쓴느거 아니다. OS 설치 영역

## 도커이미지는, 컨테이너를 만들기 위한 읽기전용 파일 시스템이다.

이런걸 외워라.

### union mount

read-only 파일 시스템을 root 파일 시스템 위에 쌓는 구조

여러 파일 시스템을 마운트하지만 하나의 파일 시스템처럼 쓸 수 있는 것

### copy-on-write CoW

이미지 파일 공유 효율을 높이기 위한 전략

- 실제로 이미지가 굉장히 많은데도 불구하고, 차지하는 공간이 적다
- 이미지를 만들시간도 굳이 복사를 안해도 되니까 적게 된다.
- 근데 분명히 하다보면 이미지 빌드를 하는 경우가 오래 걸리는 경우가있다
- 이게 바로 CoW를 하는 순간임
- 그래서 이걸 적게 만드는 형태로 이미지를 빌드할 수 있어야함.
- 도커가 레이어를 쪼개는 경우가 이 시점이다

### 도커 이미지 저장위치

클라이언트에 저장되는거 절대 아니다. path로 찾아도 안나옴.

도커 서버에서도 찾아도 안나온다.

git도 그 파일이름으로 그대로 들어가지 않는다.

다 해시로 쪼개져서 들어간다.

[Hello-world.java](http://hello-world.java) 같은 파일도

### 베이스 이미지

항상 이미지를 만들때는 베이스 이미지부터 시작한다.

처음에는 공식 베이스 이미지는 우분투였는데, 알파인으로 바뀌었다.

- 어떤 의미 : 베이스 이미지가 작으면 내 이미지가 작아지는것. 엄청 효율이 높다. 알파인이 아무래도 작으니까.
- 근데 작다보니까 패키지 매니저도 다르고 제한이 있긴함. 근데 훨씬 라이트 하니까

### 이미지의 변경된 부분만 저장어케해

변경된 부분만 따로 이미지 만들고 해시 아이디 부여해서 저장함

- git도 이렇게 저장해서 merge할때 합치고 하는거임

도커가 레이어드 이미지를 가져가기 때문에, 전체 이미지를 복사하지 않음.

구분되서 저장하고 가져오기 때문에

- 어떻게 보면 git 의 장점을 비슷하게 구현한 것

### Image Layers

도커 이미지 계층구조를 확인할 수 있다.

내가 만든 이미지가 몇개의 레이어를 가지고 있는지.

다음 교시부터 도커 이미지 만들어 본다

### Dockerfile

도커 이미지를 만들기 위해 설치할 SW, 필요한 설정을 정의할 파일

항상 FROM으로 시작한다

- 베이스 이미지를 지정하는 명령어.

#은 주석이다

MAINTANER는 누가 이 도커파일을 만들었느냐

RUN은 몇번이던 넣을 수 있음

apt-get

- 우분투의 패키지 매니저
- RUN apt-get update 는 패키지 매니저를 업데이트함
- RUN apt-get install -y nginx 이건
- -y옵션 넣으면 안물어보고 바로 설치하게 yes 넣는거
- RUN echo 'Hi, I am in your container'
- echo는 잘되나 확인하기 위해서 해놓은거.

### nginx

웹서버. 전세계에서 제일 빠른 웹서버

nginx를 도커로 띄우기 위해 도커 이미지를 만들기 위한 도커파일

### 도커 이미지를 쓸때는 도커파일을 항상 확인해라

이미지 제작 과정을 투명하게 한다.

Configuration Management 에서 말하는 프로비저닝 역할

도커이미지 스냅샷을 이용하기 위한 방법이 있긴하다

- 컨테이너 쓰고 있다가 그대로 commit 때림

### 이미지 검색

dockerhub에서 찾지 말고 바로 CLI에서 찾을 수 있다

- docker search
- ex: docker search whalesay

그리고 pull로 이미지 바로 가져온다

- docker pull docker/whalesay
- 이렇게 가져오면 hashid쭉 내려오는거 이게 레이어들이다

Step 1/3 : FROM docker/whalesay:latest
---> 6b362a9f73eb

이거 해시 코드 하나씩 나오는게

레이어드 이미지로 하나씩 만드는 것이다.

### 내 이미지 만들기

내가 풀 해온 이미지가 마음에 안들어

ㅡ럼 그 이미지를 베이스 이미지로 만들어서

내가 도커파일 만들어서 수정해서 

사용하는거야

지금 멘토님이 다르게 한거는

fortune을 다운받아서 격언을 받고

그걸 cowsay에 넘겨서 

## 도커파일 치트 시트

ADD, COPY 파일을 복사한다

- ADD를 쓰면 도커가 jar파일 자동으로 풀어서 사용할 수 있게 폴더에 넣어줌
- 그냥 복사하려면 COPY쓰는 거임

CMD

- 이미지를 실행하는 명령을 지정한다
- CMD ["mysqld"]

ONBUILD

- 이미지를 만든 후, 컨테이너를 실행할 때 실행되는 명령어를 지정한다

슬라이드에 나오는 것들 말고도 사이트에 엄청 많다

도커파일 내의 RUN의순서는 중요하다.

순차적으로 실행한다

CMD는 

순서따라가는게 아니다.

명령어는 대소문자 안가리는데, 그냥 명령어로 쓰는게 가독성으로 좋다.

EXPOSE

- 이 이미지가 80이라는 서비스를 하는 이미지야
- 이 80을 어디에 붙일지는 실제로 컨테이너 실행하고 붙이는거야.
- 실제로 어떤 포트에 붙는지

### 이미지 삭제

도커 컨테이너를 지우는건 rm

이미지를 지우는건 rmi

이미지를 참조하는 컨테이너가 있으면? 삭제가 안대

- 컨테이너부터 지우고 이미지 지워야함

모든 명령어들이 파이프라인으로 명시될 수 있다

## 도커 이미지 크기를 줄이는 방법

처음에는 작은데 근데 깔다보면 금방 1기가 2기가 된다

처음 습관을 잘 들이는게 좋다.

### 이미지를 가볍게 만드는 습관을 가지기.

이미지를 만들면

이 이미지를 베이스로 또 만들고, 그걸로 또 만들고 그러게 된다.

- 가벼운 베이스 이미지를 사용한다
    - 근데 또 우분투때 잘 도는거 같은데, 알파인때 안도는 경우가 있다
    - 그럴땐 고생하지말고 우분투 써라. 처음 할때는 잘되는게 좋다.
    - 나중에 다이제스트 하기 위해서 내린다
- 도커파일 명령은 체인으로 사용한다
    - RUN 두줄로 쓰지말고 > && 이거 이용해서 체인으로 쓴다
    - 체인으로 안쓰면 레이어 하나가 더 만들어진다
    - 하지만 무조건 다 하는건 아니다
- 빌드 도구를 설치하지 않는다
    - 빌드는 별도로 따로 해서 결과를 넣으면 된다
    - 런타임만 넣는 것이다
- 패키지 관리자를 정리한다

지금은 중요해보이지 않겠지만, 이미지 조금만 만들어보면 용량 금방 늘어나고, 한참 걸리고하면 생각난다

여러가지 많이 나오는데, 그냥 이 **4가지만 기억해라**

## 어떤 기술을 도커라이징 하느냐

Top Technologies running on Docker

이 순서대로 도커라이징하면 된다. 남들이 많이 하니까

### 도커 컨테이너 평균 지속시간 2.5일

배포를 그만큼 자주 하는 거임.

그러면 안정적으로 운영할 수 있다.

근데 꼭 2.5일이라는건 아니고 기준을 잡는 백데이터이다.

### Sysdig 2017 survey

한 호스트에 10개씩 띄우는게 평균임

- 한 호스트 컴퓨터 한대에 10개 컨테이너를 띄운다

관리도구를 많이 쓰는게 쿠버네티스

Key-value 스토어들은 대부분 컨테이너로 사용한다.

Registry 없이 도커를 쓸 수 없다.

### 도커를 얼마나 잘 사용하느냐는 Registry가 있느냐 없느냐

잘쓰는게 중요하다.

도커 이미지와 컨테이너는 99프로 똑같다

다만 읽기쓰기가 가능한 파일시스템이 도커 컨테이너

ㅣ미지를 실행한 상태가 도커 컨테이너다

도커 컨테이너는 실행된, 독립된 어플리케이션이다.

### 거듭 강조하지만 도커 컨테이너는 어플리케이션이다. 서버 아니다

어플리케이션 이상하면 내리고 다시 올리고 한다

서버관리하는건 ssh로 들어가서 고치고 하는데 아니다.

도커 컨테이너는 그냥 하나의 프로세스다

### 컨테이너는 가상 서버가 아니다

### DB 컨테인 ㅓ실행

데이터베이스는 계속 떠있어야한다.

떴다가 꺼지면 안됨. -d 써야함

daemon 이어야하니까

### 일단 띄워보고 ps 쳐보고 docker logs image-id로 본다

이렇게 해야한다.

부딪히고 고치는 방법을 익히자

### 환경변수 옵션 -e

-e MYSQL_ROOT_PASSWORD='password1!' 이런식으로 준다

### 컨테이너 이름 옵션 —name

이거 안하면 아랑서 랜덤으로 도커가 만든다

0.0.0.0은 anyware

모든 IP 가진 서버에서 접근할 수 있다

-p 80:80 하기 전까지는

호스트 서버 바깥으로 서비스를 하고 있지 않던거임

### -P 옵션은

이름도 자동으로하고 포트도 알아서함

대신 이 포트가 뭔지는 알아야함 > 나중에 멀티호스트 편에서 쓰게됨.

32768 > 32769 해서 계쏙 올라감

도커 데몬의 옵션을 바꿔주면 넘버링 범위 바꿀 수 있긴함

어플리케이션 개발자가 인프라를 배우는게 좋은 일이다

도커로 인프라 다루는 것들을 배울 수 있다

### -v 옵션이 볼륨 옵션임

어느 옵션이나

왼쪾이 호스트:오른쪽이 컨테이너

기본 사용자는 도커다

리눅스에서도 디렉토리가 /home/밑에 바로 사용자 나오듯이

지금 도커 사용자인거

### /etc/nginx/nginx.conf

이거 어케 알 수 있냐?

도커파일에 보면 알수있다. 

어디에 바인딩해야할지 아는거는 그 이미지의 도커파일보고 찾으면 된다

## —link로 컨테이너 링크해주지 않으면

격리된 애플리케이션이므로 서로가 서로의 존재를 모른다

# File Sharing 어떻게 하는지 다시 찾아서 실습 따라해두기

오늘 정리
